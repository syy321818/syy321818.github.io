---
title: "Fixing Excel VBA Runtime Error 91 - Object Variable Not Set in Data Export Macro"
date: 2025-12-14 01:13:51
tags:
  - VBA
  - Troubleshooting
  - Error 91
  - Excel Fixes
categories:
  - VBA Error Encyclopedia
description: "How to fix Excel VBA Runtime Error 91 'Object variable not set' when exporting data to CSV. Includes corrected code and prevention tips."
keywords: [Excel VBA, fix error 91, debugging, macro automation, object variable]
---

## The Symptom (The Error)

- **Error Code:** Runtime Error 91
- **Error Message:** "Object variable or With block variable not set"
- **The Scenario:** User is trying to export data from Excel to a CSV file using a VBA macro. The error occurs when attempting to write to the file.

Here's the **Bad Code** that causes this error:

```vba
Sub ExportToCSV()
    Dim outputFile As Object
    Dim myFile As String
    myFile = "C:\Reports\DataExport.csv"
    
    'This line causes Runtime Error 91
    outputFile.WriteLine "Header1,Header2,Header3"
    
    Set outputFile = CreateObject("Scripting.FileSystemObject").CreateTextFile(myFile, True)
End Sub
```

## The Root Cause

The error occurs because the code attempts to use the `outputFile` object before it's been instantiated with the `Set` command. In VBA, object variables must be explicitly set to a valid instance before their methods/properties can be accessed.

---

## The Solution (Practical Fix)

Here's the corrected code that properly initializes the object before use:

```vba
Sub ExportToCSV()
    Dim outputFile As Object
    Dim myFile As String
    Dim fso As Object
    
    myFile = "C:\Reports\DataExport.csv"
    
    'First create the object instances
    Set fso = CreateObject("Scripting.FileSystemObject")
    Set outputFile = fso.CreateTextFile(myFile, True)
    
    'Now we can safely use the object
    outputFile.WriteLine "Header1,Header2,Header3"
    outputFile.Close
    
    Set outputFile = Nothing
    Set fso = Nothing
End Sub
```

The fix works because:
1. We first create the FileSystemObject instance
2. We properly set the outputFile object BEFORE trying to use it
3. We added proper cleanup with `Set Nothing` statements
4. The operations now occur in the correct sequence

## Prevention

To avoid Runtime Error 91:
1. Always initialize object variables with `Set` before use
2. Use `Option Explicit` to catch undefined variables
3. Implement error handling with `On Error` statements
4. Add null checks before accessing object properties/methods
5. Clean up objects with `Set Variable = Nothing` when done
6. Consider using early binding for better compile-time checks:

```vba
'For early binding (add reference to Microsoft Scripting Runtime)
Dim fso As FileSystemObject
Dim outputFile As TextStream
