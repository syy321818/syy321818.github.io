---
title: "Fix Error 1004: Setting Range.FormulaArray in a Loop"
date: 2025-12-10 12:54:18
tags:
  - VBA
  - Troubleshooting
  - Runtime Error 1004
  - Excel Automation
categories:
  - VBA Error Encyclopedia
description: "Solve Runtime Error 1004 when using Range.FormulaArray in loops. Includes quick fixes and robust error handling."
keywords: [Excel VBA, Runtime Error 1004, fix Error 1004 excel, FormulaArray loop vba]

---

## The Error

- **Error Code:** Runtime Error 1004  
- **Error Message:** "Application-defined or object-defined error"  
- **The Scenario:** Occurs when looping through cells or ranges while attempting to assign array formulas (`Range.FormulaArray`) dynamically.


## The Root Cause

This error typically appears because:
1. **Formula Locking:** Excel temporarily locks formula references during loop execution.  
2. **Array Formula Limits:** Array formulas require contiguous ranges or proper syntax adjustments when assigned dynamically.  
3. **Undefined Range:** The target range may not be properly qualified (e.g., missing `Worksheet` reference).

``

## The Fix

### Method 1: The Quick Fix  
Add `DoEvents` to release Excel's internal locks:  
```vba
For Each rng In TargetRange
    rng.FormulaArray = "=SUM(A1:A10*B1:B10)"  ' Example array formula
    DoEvents  ' Releases locks
Next rng
```

### Method 2: The Robust Fix  
Use `Worksheet.Evaluate` with full range assignment:  
```vba
On Error Resume Next
Set formulaRange = Sheet1.Range("C1:C10")  ' Define target range upfront
formulaRange.FormulaArray = "=SUM(A1:A10*B1:B10)"
If Err.Number <> 0 Then
    formulaRange.Value = "Error: " & Err.Description
End If
On Error GoTo 0
```

**Why this works:**  
- `DoEvents` forces Excel to handle pending operations, resolving temporary locks.  
- Bulk assignment (`FormulaArray` on a range) avoids iterative conflicts.  

## Prevention

1. **Avoid Loops:** Prefer bulk operations over cell-by-cell assignments.  
2. **Explicit References:** Always qualify ranges with `Worksheet` objects.  
3. **Error Handling:** Wrap array formula assignments in `On Error` blocks.  
4. **Test Formulas:** Validate array formulas manually before automating.  

---