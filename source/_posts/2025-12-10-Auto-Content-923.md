---
title: "Fix Error 28: Out of Stack Space When Recursively Processing Nested Folders"
date: 2025-12-10 14:10:42
tags:
  - VBA
  - Troubleshooting
  - Runtime Error 28
  - Excel Automation
categories:
  - VBA Error Encyclopedia
description: "Resolve Excel VBA Runtime Error 28 'Out of Stack Space' when recursively scanning deeply nested folder structures with this stack-friendly fix."
keywords: [Excel VBA, Runtime Error 28, fix Error 28 excel, nested folder recursion vba, stack overflow prevention]

## The Error

- **Error Code:** Runtime Error 28
- **Error Message:** "Out of stack space"
- **The Scenario:** Occurs when recursively processing folder structures with:
  - Nested folders exceeding ~100 levels deep
  - Incorrectly terminated recursion logic
  - Large folder trees processed via `Scripting.FileSystemObject`

Example failing code:
```vba
Sub ScanFolder(path As String)
    Dim fso As Object, folder As Object, subfolder As Object
    Set fso = CreateObject("Scripting.FileSystemObject")
    Set folder = fso.GetFolder(path)
    
    For Each subfolder In folder.subfolders
        Debug.Print subfolder.Path
        ScanFolder subfolder.Path  ' Recursive call
    Next
End Sub
```

``

## The Root Cause

The VBA call stack has limited memory (typically ~64KB). Each recursive call consumes stack space for:
- Parameters
- Local variables
- Return addresses

Deep recursion exhausts this space before completing, triggering Error 28.

## The Fix

### Method 1: The Quick Fix (Iterative Approach)
Replace recursion with a stack collection:

```vba
Sub ScanFoldersSafely(rootPath As String)
    Dim fso As Object, stack As Object, currentFolder As Object
    Set fso = CreateObject("Scripting.FileSystemObject")
    Set stack = CreateObject("System.Collections.Stack")
    
    stack.Push fso.GetFolder(rootPath)
    
    Do While stack.Count > 0
        Set currentFolder = stack.Pop()
        Debug.Print currentFolder.Path
        
        For Each subfolder In currentFolder.subfolders
            stack.Push subfolder
        Next
    Loop
End Sub
```

### Method 2: The Robust Fix (Hybrid Approach)
```vba
Sub ScanFoldersAdvanced(rootPath As String)
    Const MAX_DEPTH = 50  ' Safety threshold
    Dim currentDepth As Long
    
    On Error GoTo ErrorHandler
    ScanWithDepthTracking fso.GetFolder(rootPath), currentDepth
    Exit Sub
    
ErrorHandler:
    If Err.Number = 28 Then
        MsgBox "Folder structure too deep. Processed up to " & MAX_DEPTH & " levels.", vbExclamation
    Else
        MsgBox "Error " & Err.Number & ": " & Err.Description, vbCritical
    End If
End Sub

Private Sub ScanWithDepthTracking(folder As Object, ByRef depth As Long)
    depth = depth + 1
    If depth > MAX_DEPTH Then Exit Sub
    
    Debug.Print folder.Path
    
    For Each subfolder In folder.subfolders
        ScanWithDepthTracking subfolder, depth
    Next
    
    depth = depth - 1
End Sub
```

**Why this works:**
- Method 1 eliminates recursion entirely using a stack structure
- Method 2 adds depth tracking and graceful failure
- Both approaches prevent stack exhaustion

## Prevention

1. **Always use iterative methods** for folder recursion
2. **Set maximum depth limits** even with iteration
3. **Monitor stack usage** with `CALLSTK` in debug mode
4. **Use tail recursion alternatives** where possible
5. **Document depth assumptions** in procedure headers

Best practice snippet:
```vba
' Processes folder structures iteratively
' Safe for depths up to 10,000 folders
' Uses O(1) stack space complexity
