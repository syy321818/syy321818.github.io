---
title: "Excel VBA API Calls: Stop Hardcoding URLs Like It's 1999"
date: 2025-12-10 12:14:32
tags: [Excel, VBA, API, HTTP]
categories: 'Automation Scripts'
description: "Learn to make robust API calls from Excel VBA with proper error handling, JSON parsing, and authentication. No more cURL workarounds!"
---

You've probably copy-pasted API URLs directly into your VBA code more times than you'd admit. Then the API changes, authentication breaks, and suddenly your "quick fix" turns into a debugging nightmare. Let's fix that with a professional approach to HTTP requests in VBA.

<!--more-->

## Why Most VBA API Code Sucks (And How to Fix It)

Most tutorials show you how to make a basic `MSXML2.XMLHTTP` call, but they ignore critical realities:
- APIs return errors (your code should too)
- JSON doesn't magically become usable data
- Connections time out
- Authentication tokens expire

Here's what professionals actually use:

### The Foundation: A Robust HTTP Function
```vba
Option Explicit

' Universal HTTP function with proper error handling
' Usage: 
'   Success case: HttpRequest("GET", "https://api.example.com/data", "Bearer xyz")
'   Error case: Returns Nothing and logs to Immediate Window
Function HttpRequest( _
    ByVal method As String, _
    ByVal url As String, _
    Optional ByVal authHeader As String = "", _
    Optional ByVal requestBody As String = "", _
    Optional ByVal headers As Collection = Nothing _
) As Object
    
    Dim http As Object
    Set http = CreateObject("MSXML2.XMLHTTP")
    
    On Error GoTo ErrorHandler
    
    http.Open method, url, False
    
    ' Standard headers
    http.setRequestHeader "Content-Type", "application/json"
    If authHeader <> "" Then 
        http.setRequestHeader "Authorization", authHeader
    End If
    
    ' Custom headers if provided
    If Not headers Is Nothing Then
        Dim header As Variant
        For Each header In headers
            http.setRequestHeader CStr(header), CStr(headers(header))
        Next header
    End If
    
    http.send requestBody
    
    ' Check for HTTP errors (4xx, 5xx)
    If http.Status >= 400 Then
        Err.Raise vbObjectError + http.Status, "HttpRequest", _
            "HTTP " & http.Status & " - " & http.statusText
    End If
    
    ' Return parsed JSON if content-type is JSON
    If InStr(1, http.getResponseHeader("Content-Type"), "json", vbTextCompare) > 0 Then
        Set HttpRequest = ParseJson(http.responseText)
    Else
        Set HttpRequest = CreateObject("Scripting.Dictionary")
        HttpRequest.Add "response", http.responseText
    End If
    
    Exit Function
    
ErrorHandler:
    Debug.Print "HTTP Error on " & url & ": " & Err.Description
    Set HttpRequest = Nothing
End Function
```

### JSON Parsing Without External Dependencies
```vba
' Lightweight JSON parser for VBA (converts to Dictionary/Collection)
Function ParseJson(ByVal jsonText As String) As Object
    ' Requires VBA-JSON library (https://github.com/VBA-tools/VBA-JSON)
    ' Alternative shown in comments if you can't use external libs
    Dim parser As Object
    Set parser = JsonConverter.ParseJson(jsonText)
    Set ParseJson = parser
    
    ' ALTERNATIVE WITHOUT DEPENDENCIES:
    ' Use ScriptControl (only works on Windows)
    'Dim sc As Object
    'Set sc = CreateObject("ScriptControl")
    'sc.Language = "JScript"
    'Set ParseJson = sc.Eval("(" + jsonText + ")")
End Function
```

### Real-World Usage Example
```vba
Sub GetWeatherData()
    Dim result As Object
    Dim apiUrl As String
    Dim authToken As String
    
    ' Get these from config, not hardcoded!
    apiUrl = ThisWorkbook.Names("WeatherApiUrl").RefersToRange.Value
    authToken = "Bearer " & GetCachedToken() ' Separate function for token mgmt
    
    Set result = HttpRequest("GET", apiUrl & "/current", authToken)
    
    If result Is Nothing Then
        MsgBox "API request failed - check Immediate Window", vbExclamation
        Exit Sub
    End If
    
    ' Safely access nested JSON data
    On Error Resume Next
    Dim temp As Double
    temp = result("main")("temp")
    If Err.Number <> 0 Then temp = -273 ' Absolute zero = error
    
    Sheet1.Range("A1").Value = "Current Temp: " & temp & "Â°C"
End Sub
```

## Critical Lessons Most Tutorials Miss

1. **Never hardcode credentials**: Use Excel's Named Ranges, Windows Credential Manager, or a config sheet
2. **Assume networks will fail**: That `On Error` block isn't optional - APIs go down more often than you think
3. **Cache your tokens**: Don't authenticate on every call (most APIs have rate limits)
4. **Log to the Immediate Window**: `Debug.Print` is your friend when debugging API issues

## Next Steps

For production use, add:
- Request retries with exponential backoff
- Async calls using `MSXML2.XMLHTTP60`
- Proper secret management (never store tokens in VBA)

The code above will handle 90% of real-world cases while actually failing gracefully when something goes wrong - unlike most code snippets you'll find online.
